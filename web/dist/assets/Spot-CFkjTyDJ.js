import{r as l,j as e,B as p,H as d,M as S,b as m,h as a,V as O,S as xe,L as be,G as ge,a1 as x,X as k,Y as i}from"./ui-CpDg7456.js";import{u as ye,a as je,B as fe,P as ve,O as we,D as L,T as Se,b as ke}from"./useSymbolStats-CU4nm1Xq.js";import{d as Te,e as $e,a as Ce,f as ze,A as N,n as T}from"./index-BfGfRh_G.js";import{g as h,f as D,c as X}from"./utils-pQFqaaI3.js";import"./vendor-OvXVS5lI.js";import"./charts-D8q9aCF-.js";function Ne(){const{isAuthed:u}=Te(),[E]=$e(),t=(E.get("quote")||"USDT").toUpperCase(),$=(E.get("base")||"BTC").toUpperCase().trim().replace(/\s+/g,""),[n,M]=l.useState($),[C,K]=l.useState(""),[f,b]=l.useState(""),[g,I]=l.useState(""),[y,Z]=l.useState("market"),[q,Q]=l.useState(null),[ee,U]=l.useState(!1),[j,se]=l.useState("buy"),[re,te]=l.useState([]),[ae,le]=l.useState(0),{spotStats:v,listen:H,unlisten:V}=Ce(),{orders:z,spotAvailable:_,refreshOrders:A,refreshBalances:B,positions:P}=ze(),{stats:c,loading:ie}=ye("spot",n,t);l.useEffect(()=>M($),[$]),l.useEffect(()=>(window.scrollTo(0,0),H("spot"),()=>V("spot")),[H,V]);const Y=l.useMemo(()=>{const s=new Map;return v.forEach(r=>{s.set(r.symbol,r),s.set(r.symbol.replace("_",""),r)}),s},[v]),F=l.useMemo(()=>{const s=v.filter(r=>r.symbol.endsWith(t)).map(r=>r.symbol.replace("_","").replace(t,""));return Array.from(new Set(s))},[v,t]),ne=l.useMemo(()=>{const s=C.trim().toLowerCase();return(s?F.filter(r=>r.toLowerCase().includes(s)):F).slice(0,500)},[F,C]),{availableIntervals:oe,interval:G,setInterval:de}=je({symbol:`${n}${t}`,market:"spot"}),R=async()=>{if(u)try{const s=await fetch(`${N}/api/spot/history`,{headers:{Authorization:`Bearer ${localStorage.getItem("accessToken")}`}});s.ok&&te(await s.json())}catch{}};l.useEffect(()=>{u&&R()},[u]);const J=async s=>{if(!(!f||Number(f)<=0||!localStorage.getItem("accessToken"))&&!(y==="limit"&&(!g||Number(g)<=0))){Q(s);try{const r=await fetch(`${N}/api/spot/orders`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("accessToken")}`},credentials:"include",body:JSON.stringify({symbol:`${n}${t}`,side:s,quantity:f,price:y==="limit"?g:void 0,orderType:y})});if(r.ok)b(""),I(""),A(),B(),R();else{const o=await r.json().catch(()=>null);T.show({title:"Order Error",message:o?.error||"Order failed",color:"red"})}}catch{T.show({title:"Error",message:"Order failed",color:"red"})}finally{Q(null)}}},ce=async s=>{try{const r=await fetch(`${N}/api/spot/orders/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("accessToken")}`},credentials:"include"});if(r.ok)A(),B();else{const o=await r.json().catch(()=>null);T.show({title:"Cancel Error",message:o?.error||"Cancel failed",color:"red"})}}catch{T.show({title:"Error",message:"Cancel failed",color:"red"})}},ue=l.useMemo(()=>z.filter(s=>s.status==="pending"&&!s.symbol.includes("_")),[z]),he=_?.[t]??"0",pe=P.find(s=>(s?.asset||"").toUpperCase()===n.toUpperCase())?.available??"0";return e.jsxs(p,{children:[e.jsxs(d,{align:"center",gap:"lg",py:4,children:[e.jsxs(S,{shadow:"md",width:260,position:"bottom-start",withinPortal:!0,trigger:"hover",openDelay:0,closeDelay:50,transitionProps:{transition:"pop-top-left",duration:0,timingFunction:"ease"},children:[e.jsx(S.Target,{children:e.jsx(m,{variant:"transparent",size:"lg",h:56,px:"xs",bg:"transparent",children:e.jsxs(d,{direction:"column",align:"flex-start",lh:1.2,children:[e.jsxs(a,{size:"xl",fw:700,children:[n,t]}),e.jsx(a,{size:"xxs",c:"dimmed",fw:500,tt:"uppercase",style:{letterSpacing:"0.05em"},children:"Spot"})]})})}),e.jsxs(S.Dropdown,{children:[e.jsx(p,{p:"xs",children:e.jsx(O,{placeholder:"Search pair",value:C,onChange:s=>K(s.currentTarget.value),size:"xs"})}),e.jsx(xe.Autosize,{mah:320,mx:0,type:"auto",children:ne.map(s=>e.jsxs(S.Item,{onClick:()=>M(s),children:[s,"/",t]},s))})]})]}),e.jsx(d,{align:"center",pl:24,style:{borderLeft:"1px solid var(--mantine-color-default-border)"},children:ie?e.jsx(be,{size:"xs"}):e.jsxs(ge,{gap:24,children:[e.jsx(p,{children:e.jsx(p,{fs:"1.25rem",fw:700,children:e.jsx(fe,{symbol:`${n}${t}`,market:"spot"})})}),e.jsxs(d,{direction:"column",children:[e.jsx(a,{size:"xs",c:"dimmed",fw:600,children:"24h Change"}),e.jsx(a,{size:"xs",fw:500,color:(Number(c?.change24h)||0)>=0?"var(--green)":"var(--red)",children:c?.change24h!=null?(Number(c.change24h)>=0?"+":"")+`${Number(c.change24h).toFixed(2)}%`:"-"})]}),e.jsxs(d,{direction:"column",children:[e.jsx(a,{size:"xs",c:"dimmed",fw:500,children:"24h High"}),e.jsx(a,{size:"xs",fw:600,children:c?.high24h??"-"})]}),e.jsxs(d,{direction:"column",children:[e.jsx(a,{size:"xs",c:"dimmed",fw:500,children:"24h Low"}),e.jsx(a,{size:"xs",fw:600,children:c?.low24h??"-"})]}),e.jsxs(d,{direction:"column",children:[e.jsx(a,{size:"xs",c:"dimmed",fw:500,children:"24h Volume"}),e.jsx(a,{size:"xs",fw:600,children:c?.volume24h?Number(c.volume24h).toLocaleString(void 0,{maximumFractionDigits:0}):"-"})]})]})})]}),e.jsxs(x,{gutter:"md",children:[e.jsx(x.Col,{span:{base:12,lg:10},children:e.jsxs(d,{direction:"column",gap:"md",children:[e.jsxs(x,{gutter:"md",columns:10,children:[e.jsx(x.Col,{span:{base:10,lg:8},children:e.jsx(k,{padding:0,radius:"md",withBorder:!0,shadow:"xs",children:e.jsx(ve,{onIntervalChange:de,availableIntervals:oe,symbol:`${n}${t}`,interval:G,height:630,orders:z.filter(s=>s.symbol===`${n}${t}`&&s.status==="pending")},`${n}${t}-${G}-spot`)})}),e.jsx(x.Col,{span:{base:10,lg:2},children:e.jsxs(k,{padding:0,radius:"md",withBorder:!0,shadow:"xs",h:630,children:[e.jsx(p,{bg:"var(--bg-2)",h:40,px:"md",style:{borderBottom:"1px solid var(--mantine-color-default-border)",display:"flex",alignItems:"center"},children:e.jsx(a,{size:"sm",fw:600,c:"dimmed",tt:"uppercase",style:{letterSpacing:"0.05em"},children:"Order Book"})}),e.jsx(p,{h:600,style:{overflowY:"auto"},children:e.jsx(we,{symbol:`${n}${t}`,market:"spot",depth:12})})]})})]}),e.jsx(k,{padding:0,withBorder:!0,radius:"md",h:525,style:{overflowY:"auto"},shadow:"xs",children:e.jsxs(i,{defaultValue:"history",variant:"pills",radius:"md",children:[e.jsxs(i.List,{pt:4,px:4,children:[e.jsx(i.Tab,{value:"history",children:"Trade History"}),e.jsx(i.Tab,{value:"pending",children:"Open Orders"}),e.jsx(i.Tab,{value:"positions",children:"Assets"})]}),e.jsx(i.Panel,{value:"history",p:0,children:e.jsx(L,{data:re,emptyMessage:"No trade history",columns:[{label:"Symbol",key:"symbol",render:s=>e.jsxs(d,{direction:"column",lh:1.2,gap:0,children:[e.jsx(a,{size:"sm",fw:700,children:X(s.symbol)}),s.side&&e.jsx(a,{size:"xxs",color:s.side==="buy"?"var(--green)":"var(--red)",fw:700,tt:"uppercase",children:s.side})]})},{label:"Quantity",key:"quantity",render:s=>Number(h(s.quantity||s.quantityBase||0)).toFixed(4)},{label:"Price",key:"price",render:s=>h(s.price||s.priceQuote)},{label:"Quote Amount",key:"total",render:s=>{const r=h(s.total||s.quoteAmount);return r?`${Number(r).toFixed(2)} ${t}`:"-"}},{label:"Time",key:"time",render:s=>D(s.createdAt||s.closedAt)}]})}),e.jsx(i.Panel,{value:"pending",p:0,children:e.jsx(L,{data:ue,emptyMessage:"No open orders",columns:[{label:"Symbol",key:"symbol",render:s=>e.jsxs(d,{direction:"column",lh:1.2,gap:0,children:[e.jsx(a,{size:"sm",fw:700,children:X(s.symbol)}),s.side&&e.jsx(a,{size:"xxs",color:s.side==="buy"?"var(--green)":"var(--red)",fw:700,tt:"uppercase",children:s.side})]})},{label:"Quantity",key:"quantity",render:s=>Number(h(s.quantity||s.quantityBase||0)).toFixed(4)},{label:"Price",key:"price",render:s=>h(s.price||s.priceQuote)},{label:"Status",key:"status"},{label:"Time",key:"time",render:s=>D(s.createdAt)},{label:"Action",key:"action",render:s=>e.jsx(m,{size:"compact-xs",variant:"light",color:"var(--red)",onClick:()=>ce(s.id),children:"Cancel"})}]})}),e.jsx(i.Panel,{value:"positions",p:0,children:e.jsx(L,{data:P,emptyMessage:"No assets",columns:[{label:"Asset",key:"asset"},{label:"Available",key:"available",render:s=>h(s.available)},{label:"Reserved",key:"reserved",render:s=>h(s.reserved)},{label:"Value",key:"value",render:s=>{const r=s.asset,o=parseFloat(h(s.available)||"0");if(r==="USDT"||r==="USDC")return`${o.toFixed(2)} ${t}`;{const w=`${r}${t}`,me=Y.get(w)||Y.get(w.replace("_","")),W=parseFloat(me?.lastPrice||"0");return W>0?`${(o*W).toFixed(2)} ${t}`:"-"}}},{label:"Updated",key:"updated",render:s=>D(s.updatedAt)}]})})]})})]})}),e.jsx(x.Col,{span:{base:12,lg:2},children:e.jsxs(k,{padding:0,withBorder:!0,radius:"md",h:1171,style:{overflowY:"auto"},shadow:"xs",children:[e.jsx(p,{bg:"var(--bg-2)",h:40,px:"md",style:{borderBottom:"1px solid var(--mantine-color-default-border)",display:"flex",alignItems:"center"},children:e.jsx(a,{size:"sm",fw:600,c:"dimmed",tt:"uppercase",style:{letterSpacing:"0.05em"},children:"Spot Trade"})}),e.jsxs(d,{direction:"column",gap:"md",p:"md",children:[e.jsx(i,{value:j,onChange:s=>se(s),variant:"pills",radius:"md",color:j==="buy"?"var(--green)":"var(--red)",children:e.jsxs(i.List,{grow:!0,children:[e.jsx(i.Tab,{value:"buy",children:"Buy"}),e.jsx(i.Tab,{value:"sell",children:"Sell"})]})}),e.jsx(i,{value:y,onChange:s=>Z(s),variant:"pills",radius:"md",children:e.jsxs(i.List,{grow:!0,children:[e.jsx(i.Tab,{value:"market",children:"Market"}),e.jsx(i.Tab,{value:"limit",children:"Limit"})]})}),e.jsxs(a,{size:"xs",c:"dimmed",children:["Available: ",j==="buy"?`${Number(he).toLocaleString(void 0,{maximumFractionDigits:4})} ${t} `:`${Number(pe).toLocaleString(void 0,{maximumFractionDigits:4})} ${n} `]}),y==="limit"&&e.jsx(O,{id:"price",label:"Price",placeholder:"0.00",value:g,onChange:s=>I(s.currentTarget.value),disabled:!u}),e.jsx(O,{label:"Quantity",placeholder:"0.00",value:f,onChange:s=>b(s.currentTarget.value),size:"xs",rightSection:e.jsx(a,{size:"xs",c:"dimmed",pr:"md",children:n})}),e.jsx(Se,{value:ae,onChange:s=>{if(le(s),j==="buy"){const r=parseFloat(_[t]||"0"),o=parseFloat(g)||parseFloat(c?.lastPrice||"0");o>0&&b((r*s/100/o).toFixed(8).replace(/\.?0+$/,""))}else{const r=P.find(w=>w.asset===n),o=parseFloat(r?.available||"0");b(s===100?o.toString():(o*s/100).toFixed(8).replace(/\.?0+$/,""))}}}),e.jsx(d,{gap:"md",children:j==="buy"?e.jsxs(m,{flex:1,variant:"filled",color:"var(--green)",loading:q==="buy",disabled:!u,onClick:()=>J("buy"),children:["Buy ",n]}):e.jsxs(m,{flex:1,variant:"filled",color:"var(--red)",loading:q==="sell",disabled:!u,onClick:()=>J("sell"),children:["Sell ",n]})}),e.jsx(m,{variant:"default",onClick:()=>U(!0),disabled:!u,children:"Transfer"}),e.jsx(m,{variant:"filled",color:"blue",radius:"md",onClick:()=>window.location.href="/deposit",children:"Deposit"}),!u&&e.jsx(a,{size:"xs",c:"dimmed",children:"Login to trade and see your balances."})]})]})})]}),e.jsx(ke,{opened:ee,onClose:()=>U(!1),currentSide:"spot",asset:t,onTransferred:()=>{B(),A()}})]})}export{Ne as default};
